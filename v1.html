<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Fast Position Calc</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{font-family:-apple-system,system-ui,sans-serif;-webkit-font-smoothing:antialiased}
body{background:#0d0d0d;color:#eee;line-height:1.4;min-height:100vh;padding:12px 8px}

:root{
  --bg:#0d0d0d;--card:#1a1a1a;--border:#333;
  --accent:#f0b90b;--green:#00d4aa;--red:#ff4466;--blue:#4c8bf5;
  --radius:12px;--gap:10px;
}

.container{max-width:1240px;margin:0 auto;display:grid;gap:var(--gap);grid-template-columns:1fr;}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;overflow:hidden}

h2{font-size:15px;font-weight:700;color:var(--accent);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}

.input-row{display:flex;gap:8px;align-items:center;margin-bottom:9px;flex-wrap:wrap}
.input-row label{flex:0 0 90px;font-size:13px;color:#aaa;font-weight:500}
.input-row input, .input-row select{
  flex:1;background:#111;color:#fff;border:1px solid #444;border-radius:8px;padding:10px 12px;font-size:15px;min-width:0}
.input-row input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(240,185,11,.2);outline:none}

.toggle{display:flex;background:#111;border:1px solid #444;border-radius:8px;overflow:hidden;margin-bottom:9px}
.toggle button{flex:1;padding:9px 6px;background:transparent;color:#aaa;font-weight:600;font-size:12px;border:none;cursor:pointer}
.toggle button.active{background:var(--accent);color:#000}

.lev-row{display:flex;align-items:center;gap:12px;margin-bottom:9px}
.lev-val{background:var(--accent);color:#000;padding:6px 12px;border-radius:6px;font-weight:800;font-size:14px;min-width:56px;text-align:center}

.result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px}
.res-item{background:#111;padding:10px 12px;border-radius:8px;border-left:4px solid var(--accent)}
.res-item.long{border-left-color:var(--green)}
.res-item.short{border-left-color:var(--red)}
.res-item-label{font-size:11px;color:#888;text-transform:uppercase;letter-spacing:0.5px}
.res-item-value{font-weight:700;font-size:15px;margin-top:2px}

.badge{font-size:12px;padding:4px 10px;border-radius:6px;font-weight:700;text-transform:uppercase}
.long-bg{background:#004d40;color:var(--green)}
.short-bg{background:#660022;color:var(--red)}
.rr-badge{background:#1a1a2e;color:#88f}

.btn-full{width:100%;padding:14px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:700;font-size:15px;margin-top:12px;cursor:pointer}
.btn-full:hover{filter:brightness(1.15)}

@media(min-width:768px){
  .container{grid-template-columns:380px 1fr;gap:16px}
  .calc-card{grid-row:1/3}
}
@media(min-width:1100px){
  .container{grid-template-columns:420px 1fr}
}
</style>
</head>
<body>

<div class="container">
  <!-- LEFT: INPUT siêu nhanh -->
  <div class="calc-card">
    <div class="card">
      <h2>Position Calculator <span id="directionBadge">-</span></h2>
      
      <div class="input-row"><label>Balance</label><input type="number" id="acc" placeholder="1000" value="1000"></div>
      
      <div class="input-row"><label>Risk</label>
        <div class="toggle" data-group="risk">
          <button class="active" data-mode="p">%</button>
          <button data-mode="a">$</button>
        </div>
      </div>
      <div class="input-row"><input type="number" id="rp" placeholder="1.5" step="0.1" value="1"><input type="number" id="ra" placeholder="15" style="display:none"></div>
      
      <div class="input-row"><label>Entry</label><input type="number" id="e" placeholder="30000" step="any"></div>
      
      <div class="input-row"><label>Stop Loss</label>
        <div class="toggle" data-group="sl">
          <button class="active" data-mode="p">Price</button>
          <button data-mode="pp">% Entry</button>
        </div>
      </div>
      <div class="input-row"><input type="number" id="sp" placeholder="29800" step="any"><input type="number" id="spp" placeholder="1.5" step="0.01" style="display:none"></div>
      
      <div class="input-row"><label>Take Profit</label>
        <div class="toggle" data-group="tp">
          <button data-mode="none">None</button>
          <button class="active" data-mode="rr">R:R</button>
          <button data-mode="p">Price</button>
        </div>
      </div>
      <div class="input-row">
        <input type="number" id="rr" placeholder="2.5" step="0.1" value="2.5" style="display:none">
        <input type="number" id="tp" placeholder="31000" step="any" style="display:none">
      </div>
      
      <div class="input-row"><label>Leverage</label>
        <div class="lev-row">
          <input type="range" id="lev" min="1" max="125" value="20">
          <div class="lev-val" id="levVal">20x</div>
        </div>
      </div>
      
      <button class="btn-full" onclick="calc()">CALCULATE</button>
    </div>
  </div>

  <!-- RIGHT: KẾT QUẢ siêu dễ nhìn -->
  <div class="result-card">
    <div class="card">
      <h2>Result <span id="rrBadge" class="badge rr-badge">R:R ?</span></h2>
      <div class="result-grid" id="res">
        <div style="grid-column:1/-1;text-align:center;padding:40px;color:#555">Nhập dữ liệu →</div>
      </div>
    </div>
  </div>
</div>

<script>
let riskMode='p', slMode='p', tpMode='rr';

const $ = id => document.getElementById(id);
const els = {acc:'acc',e:'e',rp:'rp',ra:'ra',sp:'sp',spp:'spp',tp:'tp',rr:'rr',lev:'lev',levVal:'levVal',res:'res',directionBadge:'directionBadge',rrBadge:'rrBadge'};

Object.keys(els).forEach(k=>els[k]=$((typeof els[k]==='string'?els[k]:k)));

function updateToggles(){
  document.querySelectorAll('.toggle').forEach(t=>{
    const group = t.dataset.group;
    const mode = group==='risk'?riskMode : group==='sl'?slMode : tpMode;
    t.querySelectorAll('button').forEach(b=>b.className = b.dataset.mode===mode?'active':'');
  });
  $('rp').parentNode.querySelectorAll('input').forEach(i=>i.style.display=i.id==='rp'&&(riskMode==='p')||i.id==='ra'&&(riskMode==='a')?'block':'none');
  $('sp').parentNode.querySelectorAll('input').forEach(i=>i.style.display=i.id==='sp'&&(slMode==='p')||i.id==='spp'&&(slMode==='pp')?'block':'none');
  
  const showRR = tpMode==='rr', showTP = tpMode==='p';
  $('rr').style.display = showRR?'block':'none';
  $('tp').style.display = showTP?'block':'none';  
  if(tpMode==='none') $('tp').value=$('rr').value='';
}

document.querySelectorAll('.toggle button').forEach(b=>{
  b.onclick=_=>{
    const g = b.closest('.toggle').dataset.group;
    if(g==='risk') riskMode=b.dataset.mode;
    if(g==='sl') slMode=b.dataset.mode;
    if(g==='tp') tpMode=b.dataset.mode;
    updateToggles(); calc();
  };
});

$('lev').oninput = e=>{ $('levVal').textContent=e.target.value+'x'; calc(); }

function calc(){
  const acc = +els.acc.value, entry = +els.e.value, lev = +els.lev.value;
  if(!acc||!entry||!lev) return;
  
  const riskPct = +els.rp.value || 0;
  const riskAmt = riskMode==='p'? acc*riskPct/100 : +els.ra.value || 0;
  if(riskAmt<=0) return;
  
  let sl;
  if(slMode==='p') sl = +els.sp.value;
  else if(slMode==='pp') sl = entry * (1 - (+els.spp.value||0)/100);
  if(!sl || Math.abs(entry-sl)<1e-8) return;
  
  const isLong = sl < entry;
  const distance = Math.abs(entry - sl);
  const size = riskAmt / distance;
  const posValue = size * entry;
  const margin = posValue / lev;
  const liq = isLong ? entry - margin/size : entry + margin/size;
  
  let tp = 0, rrRatio = 0;
  if(tpMode==='rr' && els.rr.value){
    rrRatio = +els.rr.value;
    tp = isLong ? entry + distance*rrRatio : entry - distance*rrRatio;
  } else if(tpMode==='p' && els.tp.value){
    tp = +els.tp.value;
    const profit = isLong ? (tp-entry)*size : (entry-tp)*size;
    rrRatio = (profit/riskAmt).toFixed(2);
  }
  
  const riskMarginPct = (riskAmt/margin*100).toFixed(1);
  
  els.directionBadge.className = 'badge ' + (isLong?'long-bg':'short-bg');
  els.directionBadge.textContent = isLong?'LONG ↑':'SHORT ↓';
  
  els.rrBadge.textContent = tp?`R:R 1:${rrRatio}`:'No TP';
  els.rrBadge.style.background = rrRatio>=3?'#004d40':rrRatio>=2?'#1a1a2e':'#660022';
  
  els.res.innerHTML = `
    <div class="res-item ${isLong?'long':'short'}"><div class="res-item-label">Entry</div><div class="res-item-value">${entry.toFixed(6)}</div></div>
    <div class="res-item ${isLong?'long':'short'}"><div class="res-item-label">Stop Loss</div><div class="res-item-value">${sl.toFixed(6)}</div></div>
    ${tp?`<div class="res-item ${isLong?'long':'short'}"><div class="res-item-label">Take Profit</div><div class="res-item-value">${tp.toFixed(6)}</div></div>`:''}
    <div class="res-item"><div class="res-item-label">Leverage</div><div class="res-item-value">${lev}x</div></div>
    <div class="res-item"><div class="res-item-label">Position</div><div class="res-item-value">$${posValue.toFixed(0)}</div></div>
    <div class="res-item"><div class="res-item-label">Margin</div><div class="res-item-value">$${margin.toFixed(1)}</div></div>
    <div class="res-item"><div class="res-item-label">Risk $</div><div class="res-item-value">$${riskAmt.toFixed(2)}</div></div>
    <div class="res-item ${riskMarginPct>90?'short':riskMarginPct>70?'long':''}"><div class="res-item-label">Risk/Margin</div><div class="res-item-value">${riskMarginPct}%</div></div>
    <div class="res-item"><div class="res-item-label">Liq Price</div><div class="res-item-value">${liq.toFixed(6)}</div></div>
  `;
}

// Auto calculate khi thay đổi bất kỳ input nào
document.querySelectorAll('input, button').forEach(el=>el.addEventListener('input',()=>setTimeout(calc,50)));
document.querySelectorAll('.toggle button').forEach(b=>b.addEventListener('click',calc));
updateToggles(); calc();
</script>
</body>
</html>