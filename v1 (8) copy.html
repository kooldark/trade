<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Fast Position Calc Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{font-family:-apple-system,system-ui,sans-serif;-webkit-font-smoothing:antialiased}
body{background:#0d0d0d;color:#eee;line-height:1.4;min-height:100vh;padding:12px 8px}

:root{
  --bg:#0d0d0d;--card:#1a1a1a;--border:#333;
  --accent:#f0b90b;--green:#00d4aa;--red:#ff4466;
  --radius:12px;--gap:12px;
}

/* Layout ch√≠nh */
.container{
  max-width:1400px;
  margin:0 auto;
  display:grid;
  gap:var(--gap);
  grid-template-columns:1fr;
  min-height:100vh;
}

/* Tablet & Desktop: 2 c·ªôt */
@media (min-width:768px){
  .container{
    grid-template-columns:460px 1fr;
    align-items:start;
  }
  .calc-sidebar{
    position:sticky;
    top:12px;
    max-height:calc(100vh - 24px);
    overflow-y:auto;
    padding-right:8px;
  }
  .main-content{
    display:flex;
    flex-direction:column;
    gap:var(--gap);
  }
}

/* Card chung */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:18px;
  overflow:hidden;
}

/* Ti√™u ƒë·ªÅ */
h2{
  font-size:15px;
  font-weight:700;
  color:var(--accent);
  margin-bottom:14px;
  padding-bottom:8px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* Input row */
.input-row{
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:11px;
  flex-wrap:wrap;
}
.input-row label{
  flex:0 0 90px;
  font-size:13px;
  color:#aaa;
  font-weight:500;
}
.input-row input{
  flex:1;
  background:#111;
  color:#fff;
  border:1px solid #444;
  border-radius:8px;
  padding:10px 12px;
  font-size:15px;
  min-width:0;
}
.input-row input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(240,185,11,.2);
  outline:none;
}

/* Toggle buttons */
.toggle{
  display:flex;
  background:#111;
  border:1px solid #444;
  border-radius:8px;
  overflow:hidden;
  margin-bottom:10px;
}
.toggle button{
  flex:1;
  padding:9px 6px;
  background:transparent;
  color:#aaa;
  font-weight:600;
  font-size:12px;
  border:none;
  cursor:pointer;
}
.toggle button.active{
  background:var(--accent);
  color:#000;
}

/* Leverage */
.lev-row{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.lev-presets{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-top:6px;
}
.lev-preset{
  padding:6px 11px;
  background:#222;
  border:1px solid #444;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
  transition:all .2s;
}
.lev-preset:hover{background:#333}
.lev-preset.active{
  background:var(--accent);
  color:#000;
  font-weight:700;
}
.lev-val{
  background:var(--accent);
  color:#000;
  padding:6px 12px;
  border-radius:6px;
  font-weight:800;
  font-size:14px;
  min-width:56px;
  text-align:center;
}

/* Button */
.btn-full{
  width:50%;
  padding:5px;
  background:var(--accent);
  color:#000;
  border:none;
  border-radius:8px;
  font-weight:500;
  font-size:10px;
  margin-top:8px;
  cursor:pointer;
  transition:filter .2s;
}
.btn-full:hover{filter:brightness(1.15)}
.btn-gray{background:#333;color:#fff}
.btn-danger{background:#660022;color:#fff}

/* K·∫øt qu·∫£ realtime */
.result-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:12px;
  margin:18px 0 8px;
  padding-top:14px;
  border-top:1px solid var(--border);
}
.res-item{
  background:#111;
  padding:12px 14px;
  border-radius:8px;
  border-left:4px solid var(--accent);
}
.res-item.long{border-left-color:var(--green)}
.res-item.short{border-left-color:var(--red)}
.res-item-label{
  font-size:11px;
  color:#888;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.res-item-value{
  font-weight:700;
  font-size:16px;
  margin-top:4px;
}
.risk-high{color:var(--red)!important}

/* Saved positions */
.saved-list{
  margin-top:12px;
  max-height:65vh;
  overflow-y:auto;
  padding-right:4px;
}
.saved-item{
  background:#111;
  border:1px solid #333;
  border-radius:8px;
  padding:12px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:12px;
}
.saved-name{
  font-weight:700;
  color:var(--accent);
  font-size:14px;
}
.saved-info{
  font-size:12px;
  color:#aaa;
}
.saved-actions button{
  background:transparent;
  color:#888;
  border:none;
  cursor:pointer;
  font-size:20px;
  padding:4px 8px;
}
.saved-actions button:hover{color:#fff}

.badge{
  font-size:12px;
  padding:4px 10px;
  border-radius:6px;
  font-weight:700;
  text-transform:uppercase;
}
.long-bg{background:#004d40;color:var(--green)}
.short-bg{background:#660022;color:var(--red)}
</style>
</head>
<body>

<div class="container">

  <!-- C·ªòT TR√ÅI: Calculator (sticky) -->
  <div class="calc-sidebar">
    <div class="card">
      <h2>Position Calculator <span id="directionBadge" class="badge">-</span></h2>
      
      <!-- Balance + Risk n·∫±m chung 1 d√≤ng (r·∫•t g·ªçn & pro) -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:11px;">
        <!-- Balance -->
        <div class="input-row" style="margin-bottom:0;">
          <label>Balance</label>
          <input type="number" id="acc" value="1000">
        </div>
        
        <!-- Risk -->
        <div class="input-row" style="margin-bottom:0;">
          <label style="flex: 0 0 90px;">Risk</label>
          <div style="flex: 1; display: flex; gap: 8px;">
            <div style="flex: 1; position: relative;">
              <input type="number" id="rp" placeholder="1" step="0.1" value="1" style="display:block; width: 100%;">
              <input type="number" id="ra" placeholder="15" style="display:none; width: 100%;">
            </div>
            <div class="toggle" data-group="risk" style="margin-bottom: 0;">
              <button class="active" data-mode="p">%</button>
              <button data-mode="a">$</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Entry + Stop Loss n·∫±m chung 1 d√≤ng (g·ªçn & ƒë·∫πp) -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:11px;">
        <div class="input-row" style="margin-bottom:0;">
          <label>Entry</label>
          <input type="number" id="e" placeholder="72350" step="any">
        </div>
        <div class="input-row" style="margin-bottom:0;">
          <label>Stop Loss</label>
          <input type="number" id="sp" placeholder="71500" step="any">
        </div>
      </div>
      
      <div class="input-row"><label>Take Profit</label>
        <div class="toggle" data-group="tp" style="flex:1;max-width:280px;">
          
          <button class="active" data-mode="rr">R:R</button>
          <button data-mode="price">Price</button>
        </div>
        <input type="number" id="tpInput" placeholder="2" step="any" value="2">
      </div>
      
      <div class="input-row"><label>Leverage</label>
        <div class="lev-row" style="flex:1;">
          <input type="range" id="lev" min="1" max="125" value="20" style="flex:1">
          <div class="lev-val" id="levVal">20x</div>
        </div>
        <div class="lev-presets">
          <div class="lev-preset" data-lev="5">5x</div>
          <div class="lev-preset" data-lev="10">10x</div>
          <div class="lev-preset active" data-lev="20">20x</div>
          <div class="lev-preset" data-lev="30">30x</div>
          <div class="lev-preset" data-lev="40">40x</div>
          <div class="lev-preset" data-lev="50">50x</div>
          <div class="lev-preset" data-lev="80">80x</div>
          <div class="lev-preset" data-lev="100">100x</div>
        </div>
      </div>

      <div class="action-row" style="display:flex;gap:10px;margin-top:16px;">
        <button class="btn-full" onclick="savePosition()">SAVE POSITION</button>
        <button class="btn-full btn-gray" onclick="clearForm()">CLEAR</button>
      </div>
    </div>
  </div>

  <!-- C·ªòT PH·∫¢I: K·∫øt qu·∫£ + Saved Positions -->
  <div class="main-content">

    <!-- K·∫øt qu·∫£ realtime -->
    <div class="card">
      <div id="liveResult">
        <div style="text-align:center;padding:60px;color:#555;font-size:15px">
          Nh·∫≠p Entry + Stop Loss ƒë·ªÉ t√≠nh to√°n
        </div>
      </div>
    </div>

    <!-- Saved Positions -->
    <div class="card">
      <h2>Saved Positions <span id="savedCount">0</span></h2>
      <div id="savedList" class="saved-list">
        <div style="text-align:center;padding:40px;color:#555">Ch∆∞a c√≥ v·ªã th·∫ø n√†o ƒë∆∞·ª£c l∆∞u</div>
      </div>
      <button class="btn-full btn-danger" 
        onclick="if(confirm('X√≥a t·∫•t c·∫£ v·ªã th·∫ø ƒë√£ l∆∞u?')){localStorage.removeItem('savedPositions');loadSavedPositions();}">
        CLEAR ALL POSITIONS
      </button>
    </div>
  </div>

</div>

<script>
let riskMode = 'p', tpMode = 'rr';
const $ = id => document.getElementById(id);

// === L∆∞u tr·∫°ng th√°i l·∫ßn s·ª≠ d·ª•ng cu·ªëi ===
function saveCurrentState() {
  const state = {
    acc: $('acc').value,
    riskMode, rp: $('rp').value, ra: $('ra').value,
    e: $('e').value, sp: $('sp').value,
    tpMode, tpInput: $('tpInput').value,
    lev: $('lev').value
  };
  localStorage.setItem('lastCalcState', JSON.stringify(state));
}

function loadLastState() {
  try {
    const saved = localStorage.getItem('lastCalcState');
    if (!saved) return false;
    const s = JSON.parse(saved);

    $('acc').value = s.acc || '1000';
    riskMode = s.riskMode || 'p';
    $('rp').value = s.rp || '1';
    $('ra').value = s.ra || '15';
    $('e').value = s.e || '';
    $('sp').value = s.sp || '';
    tpMode = s.tpMode || 'rr';
    $('tpInput').value = s.tpInput || '2';
    $('lev').value = s.lev || '20';

    updateToggles();
    $('levVal').textContent = (s.lev || '20') + 'x';
    document.querySelectorAll('.lev-preset').forEach(b => 
      b.classList.toggle('active', b.dataset.lev == (s.lev || '20'))
    );
    calc();
    return true;
  } catch(e) { return false; }
}

// T·ª± ƒë·ªông l∆∞u khi thay ƒë·ªïi
document.querySelectorAll('input, .toggle button, .lev-preset').forEach(el => {
  el.addEventListener('input', () => setTimeout(saveCurrentState, 100));
  el.addEventListener('click', () => setTimeout(saveCurrentState, 100));
});

// T·∫°o t√™n v·ªã th·∫ø
function generatePositionName() {
  const entry = parseFloat($('e').value) || 0;
  const sl = parseFloat($('sp').value) || 0;
  if (!entry || !sl || entry === sl) return "New Position";
  const isLong = sl < entry;
  const symbol = 'BTC';
  const rounded = entry >= 1000 ? Math.round(entry) : entry.toFixed(1);
  return `${symbol} ${isLong?'LONG':'SHORT'} ${rounded}`;
}

// Toggle & Leverage
function updateToggles(){
  document.querySelectorAll('.toggle').forEach(t => {
    const mode = t.dataset.group === 'risk' ? riskMode : tpMode;
    t.querySelectorAll('button').forEach(b => b.className = b.dataset.mode === mode ? 'active' : '');
  });
  $('rp').style.display = riskMode==='p'?'block':'none';
  $('ra').style.display = riskMode==='a'?'block':'none';
  const tpIn = $('tpInput');
  if(tpMode==='none'){ tpIn.placeholder='No TP'; tpIn.value=''; tpIn.disabled=true; }
  else if(tpMode==='rr'){ tpIn.placeholder='2 (R:R)'; if(!tpIn.value) tpIn.value=2; tpIn.disabled=false; }
  else { tpIn.placeholder='Gi√° TP'; tpIn.disabled=false; }
}

document.querySelectorAll('.toggle button').forEach(b=>b.onclick=()=>{
  const g = b.closest('.toggle').dataset.group;
  if(g==='risk') riskMode = b.dataset.mode;
  if(g==='tp') tpMode = b.dataset.mode;
  updateToggles(); calc(); saveCurrentState();
});

document.querySelectorAll('.lev-preset').forEach(b=>b.onclick=()=>{
  const v = b.dataset.lev;
  $('lev').value = v; $('levVal').textContent = v+'x';
  document.querySelectorAll('.lev-preset').forEach(x=>x.classList.toggle('active', x.dataset.lev==v));
  calc(); saveCurrentState();
});

$('lev').oninput = e => {
  const v = e.target.value;
  $('levVal').textContent = v+'x';
  document.querySelectorAll('.lev-preset').forEach(x=>x.classList.toggle('active', x.dataset.lev==v));
  calc(); saveCurrentState();
};

// T√≠nh to√°n ch√≠nh
function calc(){
  const acc = +$('acc').value || 0;
  const entry = +$('e').value || 0;
  const sl = +$('sp').value || 0;
  const lev = +$('lev').value || 1;
  const tpVal = +$('tpInput').value || 0;

  if(!acc || !entry || !sl || entry===sl){
    $('liveResult').innerHTML = '<div style="text-align:center;padding:60px;color:#555;font-size:15px">Nh·∫≠p Entry + Stop Loss ƒë·ªÉ t√≠nh to√°n</div>';
    $('directionBadge').textContent = '-'; $('directionBadge').className = 'badge';
    return;
  }

  const riskAmt = riskMode==='p' ? acc*(+$('rp').value||0)/100 : (+$('ra').value||0);
  if(riskAmt<=0){ $('liveResult').innerHTML='<div style="color:#f44;text-align:center;padding:20px">Risk ph·∫£i > 0</div>'; return; }

  const isLong = sl < entry;
  const distance = Math.abs(entry - sl);
  const size = riskAmt / distance;
  const posValue = size * entry;
  const margin = posValue / lev;
  const liq = isLong ? entry - (margin/size) : entry + (margin/size);

  let tp=0, rr=0;
  if(tpMode!=='none' && tpVal>0){
    if(tpMode==='rr'){ rr=tpVal; tp=isLong?entry+distance*rr:entry-distance*rr; }
    else{ tp=tpVal; const profit=isLong?(tp-entry)*size:(entry-tp)*size; rr=profit>0?(profit/riskAmt).toFixed(2):0; }
  }

  const riskPct = margin ? (riskAmt/margin*100).toFixed(1) : 0;
  const riskStyle = riskPct>90 ? 'risk-high' : '';

  $('directionBadge').className = 'badge '+(isLong?'long-bg':'short-bg');
  $('directionBadge').textContent = isLong?'LONG ‚Üë':'SHORT ‚Üì';

  $('liveResult').innerHTML = `
    <div class="result-grid">
      <div class="res-item ${isLong?'long':'short'}"><div class="res-item-label">Entry</div><div class="res-item-value">${entry.toFixed(6)}</div></div>
      <div class="res-item ${isLong?'long':'short'}"><div class="res-item-label">Stop Loss</div><div class="res-item-value">${sl.toFixed(6)}</div></div>
      ${tp?`<div class="res-item ${isLong?'long':'short'}"><div class="res-item-label">Take Profit</div><div class="res-item-value">${tp.toFixed(6)}</div></div>`:''}
      <div class="res-item"><div class="res-item-label">Position Value</div><div class="res-item-value">$${posValue.toFixed(0)}</div></div>
      <div class="res-item"><div class="res-item-label">Margin</div><div class="res-item-value">$${margin.toFixed(2)}</div></div>
      <div class="res-item"><div class="res-item-label">Risk $</div><div class="res-item-value">$${riskAmt.toFixed(2)}</div></div>
      <div class="res-item"><div class="res-item-label">Risk/Margin</div><div class="res-item-value ${riskStyle}">${riskPct}%</div></div>
      <div class="res-item"><div class="res-item-label">Liq Price</div><div class="res-item-value">${liq.toFixed(6)}</div></div>
      <div class="res-item"><div class="res-item-label">R:R</div><div class="res-item-value">1:${rr||'‚Äî'}</div></div>
    </div>`;
}

// SAVE / LOAD / DELETE POSITIONS
function savePosition(){
  if(!+$('e').value || !+$('sp').value){ alert('Vui l√≤ng nh·∫≠p Entry v√† Stop Loss'); return; }
  const name = generatePositionName();
  if(getPositions().some(p=>p.name===name)){
    if(!confirm(`"${name}" ƒë√£ t·ªìn t·∫°i. Ghi ƒë√®?`)) return;
  }
  const pos = {name, acc:$('acc').value, riskMode, rp:$('rp').value, ra:$('ra').value,
               e:$('e').value, sp:$('sp').value, tpMode, tpInput:$('tpInput').value,
               lev:$('lev').value, ts:Date.now()};
  let list = getPositions();
  const idx = list.findIndex(p=>p.name===name);
  if(idx>-1) list[idx]=pos; else list.push(pos);
  savePositions(list); loadSavedPositions();
  alert(`ƒê√£ l∆∞u: ${name}`);
}

function getPositions(){ try{return JSON.parse(localStorage.getItem('savedPositions'))||[]}catch(e){return[]} }
function savePositions(p){ localStorage.setItem('savedPositions', JSON.stringify(p)); }

function loadSavedPositions(){
  const list = getPositions().sort((a,b)=>b.ts-a.ts);
  $('savedCount').textContent = list.length;
  const el = $('savedList');
  if(!list.length){ el.innerHTML='<div style="text-align:center;padding:40px;color:#555">Ch∆∞a c√≥ v·ªã th·∫ø n√†o ƒë∆∞·ª£c l∆∞u</div>'; return; }
  el.innerHTML = list.map((p,i)=>{
    const long = +p.sp < +p.e;
    return `<div class="saved-item" id="pos-${i}">
      <div><div class="saved-name">${p.name}</div><div style="font-size:11px;color:#888;margin-top:4px">${new Date(p.ts).toLocaleString()}</div></div>
      <div class="saved-info">${long?'LONG':'SHORT'} @ ${p.e} ‚Ä¢ ${p.lev}x</div>
      <div class="saved-actions"><button onclick="loadPosition(${i})">‚ü≤</button><button onclick="deletePosition(${i})">üóë</button></div>
    </div>`;
  }).join('');
}

function loadPosition(i){
  const list = getPositions().sort((a,b)=>b.ts-a.ts);
  const p = list[i]; if(!p) return;
  $('acc').value=p.acc; riskMode=p.riskMode; $('rp').value=p.rp; $('ra').value=p.ra;
  $('e').value=p.e; $('sp').value=p.sp; tpMode=p.tpMode; $('tpInput').value=p.tpInput; $('lev').value=p.lev;
  updateToggles(); $('levVal').textContent=p.lev+'x';
  document.querySelectorAll('.lev-preset').forEach(b=>b.classList.toggle('active',b.dataset.lev==p.lev));
  calc(); saveCurrentState();
  window.scrollTo(0,0);
}

function deletePosition(i){
  if(!confirm('X√≥a v·ªã th·∫ø n√†y?')) return;
  let list = getPositions().sort((a,b)=>b.ts-a.ts);
  list.splice(i,1); savePositions(list); loadSavedPositions();
}

function clearForm(){
  if(!confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i?')) return;
  localStorage.removeItem('lastCalcState');
  $('acc').value='1000'; riskMode='p'; $('rp').value='1'; $('ra').value='15';
  $('e').value=''; $('sp').value=''; tpMode='rr'; $('tpInput').value='2'; $('lev').value='20';
  updateToggles(); $('levVal').textContent='20x';
  document.querySelectorAll('.lev-preset').forEach(b=>b.classList.toggle('active',b.dataset.lev=='20'));
  calc();
}

// KH·ªûI ƒê·ªòNG
loadLastState() || calc();
loadSavedPositions();

// T·ª± ƒë·ªông t√≠nh to√°n realtime
document.querySelectorAll('input').forEach(el=>el.addEventListener('input',()=>setTimeout(()=>{calc();saveCurrentState();},50)));
</script>
</body>
</html>