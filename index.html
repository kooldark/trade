<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Position Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;-webkit-font-smoothing:antialiased}
body{background:#121212;color:#e8e8e8;line-height:1.5;min-height:100vh;padding:16px 12px}

:root{
  --bg:#121212;--bg2:#1c1c1e;--bg3:#2c2c2e;--border:#3a3a3c;
  --text:#e8e8e8;--text2:#8e8e93;--accent:#f0b90b;--green:#48bb78;--red:#f6465d;
  --radius:12px;--gap:16px;
}

.container{max-width:1100px;margin:0 auto;display:grid;gap:var(--gap);grid-template-columns:1fr;grid-template-areas:"calc""res""preset""list"}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:var(--gap)}
.card-title{font-weight:700;font-size:16px;padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:12px;color:var(--accent)}

.form-group{display:flex;flex-direction:column;gap:6px}
label{font-size:13px;color:var(--text2);font-weight:500}
input[type=number],input[type=text]{
  background:var(--bg3);color:var(--text);border:1px solid var(--border);padding:12px 14px;border-radius:8px;font-size:15px;transition:border .2s;
}
input:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px rgba(240,185,11,.15)}

.toggle-group{display:flex;background:var(--bg3);border-radius:8px;padding:4px;border:1px solid var(--border);overflow:hidden}
.toggle-btn{flex:1;padding:9px 6px;background:transparent;color:var(--text2);border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
.toggle-btn.active{background:var(--accent);color:#000;font-weight:700}

.range-row{display:flex;align-items:center;gap:12px;background:var(--bg3);padding:10px;border-radius:8px;border:1px solid var(--border)}
input[type=range]{flex:1;height:6px;border-radius:3px;accent-color:var(--accent)}
.lev-val{min-width:52px;text-align:center;padding:6px 8px;background:var(--border);border-radius:6px;font-weight:700;color:var(--accent);font-size:13px}

.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:13px 16px;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:.2s}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn-secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
.grid-2 > * {min-width:0}

.result .res-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:12px}
.res-item{background:#111;padding:12px;border-radius:8px;border-left:4px solid var(--accent)}
.res-item-label{font-size:11px;color:var(--text2);margin-bottom:4px}
.res-item-value{font-weight:700;font-size:15px}
.long-badge{background:rgba(72,187,120,.15);color:var(--green);border:1.5px solid var(--green)}
.short-badge{background:rgba(246,70,93,.15);color:var(--red);border:1.5px solid var(--red)}
.direction-badge{padding:12px;border-radius:8px;text-align:center;font-weight:700;font-size:14px;text-transform:uppercase}

.presets-list{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow-y:auto;padding-right:6px}
.preset-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;gap:12px}
.preset-name{font-weight:600;color:var(--accent);font-size:14px}
.preset-note{font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.preset-time{font-size:11px;color:#777;margin-top:4px}
.preset-actions button{padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-size:12px;cursor:pointer}
.preset-actions button:hover{background:var(--accent);color:#000}

#currentPreset{margin-top:8px;font-size:13px;color:var(--accent);text-align:center}
#currentPreset span{color:var(--text2)}

@media(min-width:768px){
  .container{grid-template-columns:1fr 1fr;grid-template-areas:"calc calc""res res""preset list"}
}
@media(min-width:1100px){
  .container{grid-template-columns:repeat(4,1fr);grid-template-areas:"calc calc res res""preset preset list list"}
}
</style>
</head>
<body>

<div class="container">
  <div id="currentPreset"><span>Preset:</span> None</div>

  <!-- Calculator -->
  <div class="card" style="grid-area:calc">
    <div class="card-title">Calculation</div>
    <div class="grid-2">
      <div>
        <div class="form-group"><label>Account Balance (USDT)</label><input type="number" id="acc" placeholder="1000"></div>
        <div class="form-group">
          <label>Risk Type</label>
          <div class="toggle-group">
            <button class="toggle-btn active" data-mode="p">%</button>
            <button class="toggle-btn" data-mode="a">Fixed</button>
          </div>
          <input type="number" id="rp" placeholder="1.5%" class="risk-inp">
          <input type="number" id="ra" placeholder="15 USDT" class="risk-inp" style="display:none">
        </div>
        <div class="form-group"><label>Entry Price</label><input type="number" id="e" placeholder="30000"></div>
        <div class="form-group">
          <label>Stop Loss</label>
          <div class="toggle-group">
            <button class="toggle-btn active" data-mode="p">Price</button>
            <button class="toggle-btn" data-mode="pp">% Entry</button>
            <button class="toggle-btn" data-mode="pm">% Margin</button>
          </div>
          <input type="number" id="sp" placeholder="29800" class="sl-inp">
          <input type="number" id="spp" placeholder="% from Entry" class="sl-inp" style="display:none">
          <input type="number" id="spm" placeholder="% from Margin" class="sl-inp" style="display:none">
        </div>
      </div>
      <div>
        <div class="form-group">
          <label>Take Profit (Optional)</label>
          <div class="toggle-group">
            <button class="toggle-btn active" data-mode="p">Price</button>
            <button class="toggle-btn" data-mode="pp">% Entry</button>
            <button class="toggle-btn" data-mode="pm">% Margin</button>
          </div>
          <input type="number" id="tp" placeholder="31000" class="tp-inp">
          <input type="number" id="tpp" placeholder="% from Entry" class="tp-inp" style="display:none">
          <input type="number" id="tpm" placeholder="% from Margin" class="tp-inp" style="display:none">
        </div>
        <div class="form-group">
          <label>R:R Ratio</label>
          <div class="toggle-group" id="rrBtns">
            <button class="toggle-btn" data-rr="1">1:1</button>
            <button class="toggle-btn" data-rr="2">1:2</button>
            <button class="toggle-btn" data-rr="3">1:3</button>
            <input type="number" id="customRR" placeholder="Custom" step="0.1" style="width:70px;padding:8px;border-radius:6px;background:var(--bg3);border:none;color:var(--text)">
            <button class="toggle-btn" id="applyRR">Apply</button>
          </div>
        </div>
        <div class="form-group"><label>Leverage</label>
          <div class="range-row">
            <input type="range" id="lev" min="1" max="125" value="10">
            <div class="lev-val" id="levVal">10x</div>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top:12px" onclick="calc()">Calculate</button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="card result" id="res" style="grid-area:res">
    <div style="text-align:center;color:var(--text2);opacity:0.6">Enter data to see results</div>
  </div>

  <!-- Preset Manager -->
  <div class="card" style="grid-area:preset">
    <div class="card-title">Preset Manager</div>
    <input type="text" id="presetName" placeholder="Preset name" style="margin-bottom:8px">
    <input type="text" id="presetNote" placeholder="Note (optional)" style="margin-bottom:12px">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-secondary" id="saveBtn" onclick="savePreset()">Save</button>
      <button class="btn btn-secondary" onclick="renderPresets()">Refresh</button>
      <button class="btn btn-secondary" onclick="clearForm()">Clear</button>
    </div>
  </div>

  <!-- Saved Presets -->
  <div class="card" style="grid-area:list">
    <div class="card-title">Saved Presets</div>
    <div class="presets-list" id="presetList">
      <div style="text-align:center;color:var(--text2);opacity:0.6;padding:20px">No presets yet</div>
    </div>
  </div>
</div>

<script>
// Compact & optimized JS
let riskMode='p', slMode='p', tpMode='p', editing=null;

const els = {
  acc:()=>document.getElementById('acc'), e:()=>document.getElementById('e'),
  rp:()=>document.getElementById('rp'), ra:()=>document.getElementById('ra'),
  sp:()=>document.getElementById('sp'), spp:()=>document.getElementById('spp'), spm:()=>document.getElementById('spm'),
  tp:()=>document.getElementById('tp'), tpp:()=>document.getElementById('tpp'), tpm:()=>document.getElementById('tpm'),
  lev:()=>document.getElementById('lev'), levVal:()=>document.getElementById('levVal'),
  res:()=>document.getElementById('res'), presetList:()=>document.getElementById('presetList'),
  current:()=>document.getElementById('currentPreset')
};

function save(){localStorage.positionData=JSON.stringify({
  acc:els.acc().value,riskMode,slMode,tpMode,
  rp:els.rp().value,ra:els.ra().value,e:els.e().value,
  sp:els.sp().value,spp:els.spp().value,spm:els.spm().value,
  tp:els.tp().value,tpp:els.tpp().value,tpm:els.tpm().value,lev:els.lev().value
})}

function load(){
  const d = JSON.parse(localStorage.positionData||'{}');
  if(!d) return;
  els.acc().value=d.acc||''; els.e().value=d.e||''; els.lev().value=d.lev||10; els.levVal().textContent=(d.lev||10)+'x';
  els.rp().value=d.rp||''; els.ra().value=d.ra||''; els.sp().value=d.sp||''; els.tp().value=d.tp||'';
  riskMode=d.riskMode||'p'; slMode=d.slMode||'p'; tpMode=d.tpMode||'p';
  updateInputs(); calc();
}

function updateInputs(){
  document.querySelectorAll('.risk-inp').forEach(e=>e.style.display='none');
  document.querySelectorAll('.sl-inp').forEach(e=>e.style.display='none');
  document.querySelectorAll('.tp-inp').forEach(e=>e.style.display='none');
  els.rp().style.display = riskMode==='p'?'block':'none';
  els.ra().style.display = riskMode==='a'?'block':'none';
  els.sp().style.display = slMode==='p'?'block':'none';
  els.spp().style.display = slMode==='pp'?'block':'none';
  els.spm().style.display = slMode==='pm'?'block':'none';
  els.tp().style.display = tpMode==='p'?'block':'none';
  els.tpp().style.display = tpMode==='pp'?'block':'none';
  els.tpm().style.display = tpMode==='pm'?'block':'none';
}

// Toggle handlers
document.querySelectorAll('[data-mode]').forEach(btn=>{
  btn.onclick = e=>{
    const group = e.target.parentElement.parentElement;
    const mode = e.target.dataset.mode;
    group.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    if(group.querySelector('.risk-inp')) riskMode=mode;
    if(group.querySelector('.sl-inp')) slMode=mode;
    if(group.querySelector('.tp-inp')) tpMode=mode;
    updateInputs(); save(); calc();
  }
});

document.getElementById('lev').oninput = e=>{ els.levVal().textContent=e.target.value+'x'; save(); calc(); }
document.getElementById('applyRR').onclick = ()=>{ const v=parseFloat(document.getElementById('customRR').value); if(v>0) setRR(v); }
document.querySelectorAll('#rrBtns [data-rr]').forEach(b=>b.onclick=()=>setRR(parseFloat(b.dataset.rr)));

function setRR(ratio){
  const e=parseFloat(els.e().value), sp=parseFloat(els.sp().value);
  if(isNaN(e)||isNaN(sp)) return alert('Need Entry & SL price');
  const diff=Math.abs(e-sp), isLong=sp<e;
  const tp = isLong ? e + diff*ratio : e - diff*ratio;
  els.tp().value = tp.toFixed(6); tpMode='p'; updateInputs(); calc();
}

// Preset system
function getPresets(){ return JSON.parse(localStorage.positionPresets||'[]') }
function savePresets(a){ localStorage.positionPresets=JSON.stringify(a.sort((a,b)=>b.ts-a.ts)) }

function renderPresets(){
  const list = els.presetList();
  const presets = getPresets();
  list.innerHTML = presets.length===0 ? '<div style="text-align:center;color:var(--text2);opacity:0.6;padding:20px">No presets yet</div>' : '';
  presets.forEach(p=>{
    const div=document.createElement('div'); div.className='preset-item';
    div.innerHTML = `
      <div>
        <div class="preset-name">${p.name}</div>
        ${p.note?`<div class="preset-note">${p.note}</div>`:''}
        <div class="preset-time">${new Date(p.ts).toLocaleString()}</div>
      </div>
      <div class="preset-actions">
        <button onclick="loadPreset('${p.name}')">Load</button>
        <button style="color:var(--red)" onclick="delPreset('${p.name}')">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}

function savePreset(){
  let name=document.getElementById('presetName').value.trim()||`Preset ${new Date().toLocaleDateString()}`;
  const note=document.getElementById('presetNote').value.trim();
  const data = {
    acc:els.acc().value,riskMode,slMode,tpMode,
    rp:els.rp().value,ra:els.ra().value,e:els.e().value,
    sp:els.sp().value,spp:els.spp().value,spm:els.spm().value,
    tp:els.tp().value,tpp:els.tpp().value,tpm:els.tpm().value,lev:els.lev().value
  };
  let presets=getPresets();
  const idx = presets.findIndex(x=>x.name===name);
  if(idx>=0){ if(!confirm('Overwrite?')) return; presets[idx]={name,note,ts:Date.now(),data}; }
  else presets.push({name,note,ts:Date.now(),data});
  savePresets(presets); renderPresets(); clearForm();
}

function loadPreset(name){
  const p = getPresets().find(x=>x.name===name);
  if(!p) return;
  const d=p.data;
  els.acc().value=d.acc||''; els.e().value=d.e||''; els.lev().value=d.lev||10; els.levVal().textContent=(d.lev||10)+'x';
  riskMode=d.riskMode||'p'; slMode=d.slMode||'p'; tpMode=d.tpMode||'p';
  els.rp().value=d.rp||''; els.ra().value=d.ra||''; els.sp().value=d.sp||''; els.tp().value=d.tp||'';
  updateInputs(); calc();
  document.getElementById('currentPreset').innerHTML=`<span>Preset:</span> ${name}`;
}

function delPreset(name){ if(confirm('Delete?')){ savePresets(getPresets().filter(x=>x.name!==name)); renderPresets(); } }
function clearForm(){ document.getElementById('presetName').value=''; document.getElementById('presetNote').value=''; }

// Main calculator
function calc(){
  const acc=parseFloat(els.acc().value), e=parseFloat(els.e().value), lev=parseFloat(els.lev().value);
  if(isNaN(acc)||isNaN(e)||isNaN(lev)){ els.res().innerHTML='<div style="text-align:center;color:var(--text2);opacity:0.6">Enter required data</div>'; return; }

  let riskAmt = riskMode==='p' ? acc*(parseFloat(els.rp().value)||0)/100 : parseFloat(els.ra().value)||0;
  if(isNaN(riskAmt)||riskAmt<=0) return;

  let sl;
  if(slMode==='p') sl=parseFloat(els.sp().value);
  else if(slMode==='pp') sl = e*(1-(parseFloat(els.spp().value)||0)/100);
  else sl = e - riskAmt*(parseFloat(els.spm().value)||0)/100;

  if(isNaN(sl)||Math.abs(e-sl)<1e-8){ els.res().innerHTML='<div style="color:var(--red)">SL cannot equal Entry</div>'; return; }

  const diff=Math.abs(e-sl), size=riskAmt/diff, value=size*e, margin=value/lev, isLong=sl<e;
  const liq = isLong ? e-(margin/size) : e+(margin/size);
  const pctSL = (diff/e*100).toFixed(2);
  const pctRiskMargin = (riskAmt/margin*100).toFixed(2);

  let tp=0, tpText='', rr='N/A';
  if(els.tp().value){
    if(tpMode==='p') tp=parseFloat(els.tp().value);
    else if(tpMode==='pp') tp = isLong ? e*(1+(parseFloat(els.tpp().value)||0)/100) : e*(1-(parseFloat(els.tpp().value)||0)/100);
    else tp = isLong ? e + riskAmt*(parseFloat(els.tpm().value)||0)/100 : e - riskAmt*(parseFloat(els.tpm().value)||0)/100;
    if((isLong&&tp<=e)||(!isLong&&tp>=e)) tp=0;
    else {
      const gain=isLong?(tp-e)*size:(e-tp)*size;
      rr = (gain/riskAmt).toFixed(2);
    }
  }

  const badge = isLong ? '<div class="direction-badge long-badge">LONG</div>' : '<div class="direction-badge short-badge">SHORT</div>';
  let html = `<div style="font-weight:700;color:var(--accent);margin-bottom:12px">Results ${badge}</div><div class="res-grid">
    <div class="res-item"><div class="res-item-label">Entry</div><div class="res-item-value">${e.toFixed(4)}</div></div>
    <div class="res-item"><div class="res-item-label">Stop Loss</div><div class="res-item-value">${sl.toFixed(4)}</div></div>
    ${tp?`<div class="res-item" style="border-left-color:var(--green)"><div class="res-item-label">Take Profit</div><div class="res-item-value">${tp.toFixed(4)}</div></div>`:''}
    <div class="res-item"><div class="res-item-label">Leverage</div><div class="res-item-value">${lev}x</div></div>
    <div class="res-item"><div class="res-item-label">Position Value</div><div class="res-item-value">$${value.toFixed(2)}</div></div>
    <div class="res-item"><div class="res-item-label">Margin Used</div><div class="res-item-value">$${margin.toFixed(2)}</div></div>
    <div class="res-item"><div class="res-item-label">Risk Amount</div><div class="res-item-value">-$${riskAmt.toFixed(2)}</div></div>
    <div class="res-item ${pctRiskMargin>90?'danger':''}"><div class="res-item-label">Risk/Margin</div><div class="res-item-value">${pctRiskMargin}%</div></div>
    <div class="res-item"><div class="res-item-label">SL Distance</div><div class="res-item-value">${pctSL}%</div></div>
    ${tp?`<div class="res-item" style="color:var(--green)"><div class="res-item-label">R:R</div><div class="res-item-value">1:${rr}</div></div>`:''}
    <div class="res-item" style="grid-column:1/-1;background:rgba(240,185,11,.12);border-left-color:var(--accent)"><div class="res-item-label">Est. Liquidation</div><div class="res-item-value" style="color:var(--accent)">${liq.toFixed(4)}</div></div>
  </div>`;
  if(pctRiskMargin>90) html+=`<div style="margin-top:12px;padding:12px;background:rgba(246,70,93,.2);color:var(--red);border-radius:8px;text-align:center;font-weight:600">HIGH RISK: Risk/Margin > 90%</div>`;
  els.res().innerHTML=html;
}

window.onload=()=>{ load(); renderPresets(); updateInputs(); }
document.querySelectorAll('input').forEach(i=>i.oninput=()=>{save();setTimeout(calc,100)});

</script>
</body>
</html>